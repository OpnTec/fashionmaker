language: cpp
matrix:
  include:
  - os: linux
    dist: trusty
    sudo: required
    compiler: clang
    env: DEPLOY=false
  - os: osx
    compiler: clang
    env: DEPLOY=true
before_install:
- |
  if [[ "$TRAVIS_OS_NAME" == "linux" ]]; then
    sudo apt-get -qq update;
    sudo apt-get install -y qtbase5-dev;
    sudo apt-get install -y libqt5svg5-dev;
    sudo apt-get install -y qt5-default;
    sudo apt-get install -y qttools5-dev-tools;
    sudo apt-get install -y libqt5xmlpatterns5-dev;
    sudo apt-get install -y libqt5core5a;
    sudo apt-get install -y libqt5gui5;
    sudo apt-get install -y libqt5printsupport5;
    sudo apt-get install -y libqt5svg5;
    sudo apt-get install -y libqt5widgets5;
    sudo apt-get install -y libqt5xml5;
    sudo apt-get install -y libqt5xmlpatterns5;
    sudo apt-get install -y xpdf;
    sudo apt-get install -y xvfb;
  else
    brew update > /dev/null;
    brew install qt5;
    chmod -R 755 /usr/local/opt/qt5/*
  fi
before_script:
- |
  if [[ "$TRAVIS_OS_NAME" == "linux" ]]; then
    uname -a;
    which qmake;
  else
    QTDIR="/usr/local/opt/qt5";
    PATH="$QTDIR/bin:$PATH";
    LDFLAGS=-L$QTDIR/lib;
    CPPFLAGS=-I$QTDIR/include;
    PKG_CONFIG_PATH=/usr/local/opt/qt5/lib/pkgconfig;
  fi
- mkdir build
- cd build
- pwd
- qmake --version
- qmake ../Valentina.pro -r CONFIG+=noDebugSymbols CONFIG+=no_ccache CONFIG+=checkWarnings
script:
- $CXX --version
- |
  if [[ "$TRAVIS_OS_NAME" == "linux" ]]; then
    make -j$(nproc);
    export LD_LIBRARY_PATH=$LD_LIBRARY_PATH:"$TRAVIS_BUILD_DIR/build/src/libs/vpropertyexplorer/bin:$TRAVIS_BUILD_DIR/build/src/libs/qmuparser/bin";
    xvfb-run -a make --silent check TESTARGS="-silent";
  else
    make -j1;
  fi  
notifications:
  email:
    recipients:
    - dismine@gmail.com
    - susan.spencer@gmail.com
    on_success: change
    on_failure: always
before_deploy:
- |
  if [[ "$DEPLOY" == "true" ]]; then
    zip -r valentina-osx-${TRAVIS_COMMIT}.zip $TRAVIS_BUILD_DIR/build/src/app/valentina/bin/Valentina.app/ -x "*.DS_Store";
  fi
deploy:
  provider: bintray
  skip_cleanup: true
  file: ../share/bintray.json
  user: dismine
  key:
    secure: FGRiPJ/j0fzaCndLDruaDuSdP0H1kfSGW/b/ZPQpr2uVdNKp7PvGfEfElqOJhwcSM/vq9PEic2KLY/SE6zXtwW9I1ijqmxBvgQ+XB89L/cQb5weWEnUuGdBzQe7BGWNVDkH8Rv2xZQxK2v34UE2uxq1W1nXtf8oug9N0AtPmMUGOxOVjnMkx1g0HPNFgvXJjf9VuOEsWOHd/Lv7prnGFmJsoMg+6zTsh4hRdiIdoqXK/weEGY1+aJ5GBlJvRRzTT8pQ767afzOLeNx1wYIapc36txpXcIfpRX/EFZL1btPasB9FNv6D1gSqmZTfd3pDukzN17LhOhFZKTJCDWYzOraVs85p3nejPZRUgVdLq5VZmQAqyKfGLBIkatZC/y8xFGlbwrUvSztH6DcISBmLRDdONSyE6Q+lbUaW37FwFr8xLp4tJFTV+qUreBQtT86UHmhODtY8HQQyMMWY/C+i2Ro1cTQ1/fCg/Vnk3Ae77Z6knqA7A7ZcMMiHTtg9/qzGmtSrF0i2qFUkQZMlUlWfqJa5vyrVxtJkDqsSeEZE2XvRgWisKaVN3F5lEkcNBwwk9HyDm0G8k/mupL7FkS9QAwZoycsgQZCPh1nasGaD3g5AvNJzltxwxCPZc56leTbqQi1/qGWhwbtaRHXUyaDmb0eMV7VH+ENcS6qdebSz5eK0=
  dry-run: false
  on:
    all_branches: true
    condition: $DEPLOY = true
